---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}
suppressPackageStartupMessages({
    library(ggplot2)
    library(GGally)
    library(GSEABase)
    library(limma)
    library(reshape2)
    library(data.table)
    library(knitr)
    library(TxDb.Hsapiens.UCSC.hg19.knownGene)
    library(stringr)
    library(NMF)
    library(rsvd)
    library(RColorBrewer)
    library(MAST)
})
```


```{r}
freq_expressed <- 0.2
FCTHRESHOLD <- log2(1.5)
```


```{r}
# simulated.data<-read.csv("~/Documents/Documents/Summer_2019/Mouse_Liver/Rance/snSeq-DGE/SplattDR/normexp_splattdr.txt", sep="")
# simulated.cell.metadata<-read.csv("~/Documents/Documents/Summer_2019/Mouse_Liver/Rance/snSeq-DGE/SplattDR/cellMeta_splattdr.txt", sep="")
# simulated.gene.metadata<-read.csv("~/Documents/Documents/Summer_2019/Mouse_Liver/Rance/snSeq-DGE/SplattDR/geneMeta_splattdr.txt", sep="")
# a=apply(simulated.data,1, function(x) length(which(x==0)))
# b<-which(a==ncol(simulated.data))
# simulated.data<-simulated.data[-b,]
# simulated.gene.metadata<-simulated.gene.metadata[-b,]
```

```{r}
simD.list.sparse<-readRDS("~/Documents/Documents/Summer_2019/Mouse_Liver/Rance/snSeq-DGE/simDR.list.sparse.RData")
```

```{r}
#Read data from a single cell object
simulated.data<-logcounts(simD.list.sparse$`Stellate Cells 0.1 3 0.111111111111111:0.111111111111111:0.111111111111111:0.111111111111111:0.111111111111111:0.111111111111111:0.111111111111111:0.111111111111111:0.111111111111111`)
simulated.cell.metadata<-colData(simD.list.sparse$`Stellate Cells 0.1 3 0.111111111111111:0.111111111111111:0.111111111111111:0.111111111111111:0.111111111111111:0.111111111111111:0.111111111111111:0.111111111111111:0.111111111111111`)
simulated.gene.metadata<-rowData(simD.list.sparse$`Stellate Cells 0.1 3 0.111111111111111:0.111111111111111:0.111111111111111:0.111111111111111:0.111111111111111:0.111111111111111:0.111111111111111:0.111111111111111:0.111111111111111`)
a=apply(simulated.data,1, function(x) length(which(x==0)))
b<-which(a==ncol(simulated.data))
simulated.data<-simulated.data[-b,]
simulated.gene.metadata<-simulated.gene.metadata[-b,]
```

```{r}
library(MAST)
scaRaw <- FromMatrix(as.matrix(simulated.data), as.data.frame(simulated.cell.metadata), as.data.frame(simulated.gene.metadata),check_sanity = FALSE)
```


`FromMatrix` constructs an object from a matrix (genes $\times$ cells) of expression, a `data.frame` of cell-level covariance and a `data.frame` of feature-level covariates.
In this case, there are `r ncol(scaRaw)` single cells measured over `r nrow(scaRaw)` genes.
We derive from the `SummarizedExperiment` class, which makes it easy for feature (row) and cell (column) metadata to come along for the ride.
There is also a constructor, `FromFlatDF` for flattened data where measurements, and cell and feature covariates are intermingled.

```{r}
set.seed(123)
plotPCA <- function(sca_obj){
    projection <- rpca(t(assay(sca_obj)), retx=TRUE, k=4)$x
    colnames(projection)=c("PC1","PC2","PC3","PC4")
    pca <- data.table(projection,  as.data.frame(colData(sca_obj)))
    print(ggpairs(pca, columns=c('PC1', 'PC2', 'PC3'),
            mapping=aes(color=Dose), upper=list(continuous='blank')))
    invisible(pca)
}

plotPCA(scaRaw)
```

```{r}
cdr <-colSums(assay(scaRaw)>0)
colData(scaRaw)$cngeneson <- scale(cdr)
filterCrit <- with(colData(scaRaw),cngeneson > 1)
rowData(scaRaw)$symbolid <- rownames(simulated.gene.metadata)
```

```{r}
sca <- subset(scaRaw,filterCrit)
scaSample <- sca[sample(which(freq(sca)>.1), 20),]
flat <- as(scaSample, 'data.table')
ggplot(flat, aes(x=value))+geom_density() +facet_wrap(~symbolid, scale='free_y')

```
Here weâ€™ve taken subsample of size 20, then flattened it into a  data.table to make it easy to plot with ggplot2.

Hurdle Model

```{r}
Dose<-factor(colData(scaRaw)$Dose)
Dose<-relevel(Dose,"0")
colData(scaRaw)$Dose<-Dose
zlmDose <- zlm(~Dose + cngeneson, scaRaw)
```

```{r}
#only test the condition coefficient.
summaryDose<-rep(list(list()),times= nlevels(Dose)-1)
names(summaryDose)<-levels(Dose)[2:9]
for(i in levels(Dose)[2:9])
{
    summaryDose[[i]]<-summary(zlmDose, doLRT=paste0("Dose",i))
}
```

```{r}
summaryDT<-rep(list(data.table()),times=nlevels(Dose)-1)
names(summaryDT)<-levels(Dose)[2:9]
fcHurdle<-rep(list(data.table()),times=nlevels(Dose)-1)
names(fcHurdle)<-levels(Dose)[2:9]
fcHurdleSig<-rep(list(data.table()),times=nlevels(Dose)-1)
names(fcHurdleSig)<-levels(Dose)[2:9]
fcHurdleNonSig<-rep(list(data.table()),times=nlevels(Dose)-1)
names(fcHurdleSig)<-levels(Dose)[2:9]
TP_dose<-rep(list(data.table()),times=nlevels(Dose)-1)
names(TP_dose)<-levels(Dose)[2:9]
FP_dose<-rep(list(data.table()),times=nlevels(Dose)-1)
names(FP_dose)<-levels(Dose)[2:9]
TN_dose<-rep(list(data.table()),times=nlevels(Dose)-1)
names(TN_dose)<-levels(Dose)[2:9]
FN_dose<-rep(list(data.table()),times=nlevels(Dose)-1)
names(FN_dose)<-levels(Dose)[2:9]

for(i in levels(Dose)[2:9])
{
   summaryDT[[i]] <-summaryDose[[i]]$datatable
   fcHurdle[[i]]<-summaryDT[[i]][contrast== paste0("Dose",i) & component=='H',.(primerid, `Pr(>Chisq)`)] #logFC coefficients
   fcHurdle[[i]][,fdr:=p.adjust(`Pr(>Chisq)`, 'fdr')]
   fcHurdleSig[[i]]<- fcHurdle[[i]][fdr<.05 ]
   setorder(fcHurdleSig[[i]], fdr)
   fcHurdleNonSig[[i]]<- fcHurdle[[i]][fdr >.05| fdr == 0.05]
   setorder(fcHurdleNonSig[[i]], fdr)
}

```



```{r}
sig<-(union(fcHurdleSig[["0.01"]]$primerid,union(fcHurdleSig[["0.03"]]$primerid,union(fcHurdleSig[["0.1"]]$primerid,union(fcHurdleSig[["0.3"]]$primerid,union(fcHurdleSig[["1"]]$primerid,union(fcHurdleSig[["3"]]$primerid,union(fcHurdleSig[["10"]]$primerid,fcHurdleSig[["30"]]$primerid))))))))
true_dec<-ifelse(simulated.gene.metadata$Model=="Unchanged","Negative","Positive")
pred_dec_MAST_comb<-ifelse(rownames(simulated.gene.metadata)%in%sig == TRUE,"Positive","Negative")
caret::confusionMatrix(factor(pred_dec_MAST_comb,levels=c("Positive","Negative")),factor(true_dec,levels=c("Positive","Negative")))
```
```{r}
#Calculate log fold change pairwise
log_fold_change<-rep(list(vector(mode = "numeric",
                             length = nrow(data[["0"]]))), nlevels(dose_level)-1)
names(log_fold_change)<-levels(dose_level)[-1]
for (i in levels(dose_level)[-1])
{
  for(k in 1: nrow(data[["0"]]))
  {
  log_fold_change[[i]][k] = logFC(data[["0"]][k,],data[[i]][k,])
  }
}
log_fold_change_gene_median<-vector()
  for (j in 1: nrow(data[["0"]]))
  {
    log_fold_change_gene_median[j]<-median(abs(log_fold_change[["0.01"]][j]),
                                    abs(log_fold_change[["0.03"]][j]),
                                    abs(log_fold_change[["0.1"]][j]),
                                    abs(log_fold_change[["0.3"]][j]),
                                    abs(log_fold_change[["1"]][j]),
                                    abs(log_fold_change[["3"]][j]),
                                    abs(log_fold_change[["10"]][j]),
                                    abs(log_fold_change[["30"]][j]))
  }
names(log_fold_change_gene_median)<-rownames(data[["0"]])
```


```{r}
fcHurdle_lfc<-Map(data.frame, fcHurdle,log_fold_change)
fcHurdleSig_lfc<-rep(list(data.table()),nlevels(Dose)-1)
names(fcHurdleSig_lfc)<-levels(Dose)[-1]
for(i in levels(Dose)[-1])
{
    colnames(fcHurdle_lfc[[i]])<-c("primerid","Pr..Chisq.","fdr","lfc")
    fcHurdleSig_lfc[[i]]<-fcHurdle_lfc[[i]][fcHurdle_lfc[[i]]$fdr<0.05
                            & abs(fcHurdle_lfc[[i]]$lfc) >log(1.5),]
    setorder(fcHurdleSig_lfc[[i]], fdr)
}

sig_lfc<-(union(fcHurdleSig_lfc[["0.01"]]$primerid,union(fcHurdleSig_lfc[["0.03"]]$primerid,union(fcHurdleSig_lfc[["0.1"]]$primerid,union(fcHurdleSig_lfc[["0.3"]]$primerid,union(fcHurdleSig_lfc[["1"]]$primerid,union(fcHurdleSig_lfc[["3"]]$primerid,union(fcHurdleSig_lfc[["10"]]$primerid,fcHurdleSig_lfc[["30"]]$primerid))))))))
pred_dec_MAST_comb_lfc<-ifelse(rownames(simulated.gene.metadata)%in%sig_lfc == TRUE,"Positive","Negative")
caret::confusionMatrix(factor(pred_dec_MAST_comb_lfc,levels=c("Positive","Negative")),factor(true_dec,levels=c("Positive","Negative")))
```

