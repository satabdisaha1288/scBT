---
title: "Benchmarking DE Tests"
author: 
  - "Rance Nault"
  - "Satabdi Saha"
package: "statsDR"
data: "Last updated: April 12, 2021"
output: 
  BiocStyle::html_document:
    toc: true
    toc_float: true
  vignette: >
    %\VignetteIndexEntry{simple example}
    %\VignetteEngine{knitr::rmarkdown}
    %\VignetteEncoding{UTF-8}
---

```{r}
suppressPackageStartupMessages({
  library("splattdr")
  library("snseq.stats")
  library("dplyr")
  library("DescTools")
  library("ggplot2")
  library("MAST")
})

#data(params)
p <- readRDS('/mnt/home/naultran/drSims/params.list.RData')
params <- p[[1]]

sim.dose = c(0, 0.01, 0.03, 0.1, 0.3, 1, 3, 10, 30)
dose.prob = rep(1/9, 9)

params@nGenes = 2000
```

```{r}
parameter.updates <- read.table('ParTestsCombos.txt', header = TRUE, sep = '\t')
```

```{r}
DGE1 = list()
AUC1 = list()
AUC2 = list()
AUPR1 = list()
AUPR2 = list()
B.LIST = list()
pHH0 = list()

for (n in 1:nrow(parameter.updates)){
  print(n)
  params@de.facLoc = rep(parameter.updates$FacLoc[n], params@nBatches)
  params@de.facScale = rep(parameter.updates$FacScale[n], params@nBatches)
  params@nCells = parameter.updates$CellN[n]*9
  params@de.prob = parameter.updates$deProb[n]
  params@de.downProb = parameter.updates$deDown[n]
  params@seed = parameter.updates$seed[n]
  
  sim = splatSimulateDR(params, dose.names = sim.dose, dose.prob = dose.prob, lib.scale = 1.3, verbose = FALSE)
  DGE1[[parameter.updates$TestName[n]]] = DETest(sim, method = c("All"), fixed.priors = FALSE, verbose = TRUE)
  
  ######## MAST #####
  sce = sim
  scaRaw <- FromMatrix(as.matrix(logcounts(sce)),
                      data.frame(colData(sce)),
                      data.frame(rowData(sce))
  )
  cdr <- colSums(assay(scaRaw) > 0)
  colData(scaRaw)$cngeneson <- scale(cdr)
  #filterCrit = with(colData(scaRaw), cngeneson > 1)
  rowData(scaRaw)$symbolid <- rownames(rowData(sce))
  Dose <- factor(colData(scaRaw)$Dose)
  Dose <- relevel(Dose,"0")
  colData(scaRaw)$Dose <- Dose
  zlmDose <- zlm(~Dose + cngeneson, sca = scaRaw)
  
  summaryDose <- rep(list(list()), times = nlevels(Dose)-1)
  names(summaryDose) <- levels(Dose)[-1]
  for(i in levels(Dose)[-1])
  {
    summaryDose[[i]] <- summary(zlmDose, doLRT=paste0("Dose",i))
  }
  
  summaryDT <- rep(list(data.table::data.table()),times=nlevels(Dose)-1)
  names(summaryDT) <- levels(Dose)[-1]
  fcHurdle <- rep(list(data.table::data.table()),times=nlevels(Dose)-1)
  names(fcHurdle) <- levels(Dose)[-1]
  fcHurdleSig <- rep(list(data.table::data.table()),times=nlevels(Dose)-1)
  names(fcHurdleSig) <- levels(Dose)[-1]
  fcHurdleNonSig <- rep(list(data.table::data.table()),times=nlevels(Dose)-1)
  names(fcHurdleSig) <- levels(Dose)[-1]
  TP_dose <- rep(list(data.table::data.table()),times=nlevels(Dose)-1)
  names(TP_dose) <- levels(Dose)[-1]
  FP_dose <- rep(list(data.table::data.table()),times=nlevels(Dose)-1)
  names(FP_dose) <- levels(Dose)[-1]
  TN_dose <- rep(list(data.table::data.table()),times=nlevels(Dose)-1)
  names(TN_dose) <- levels(Dose)[-1]
  FN_dose <- rep(list(data.table::data.table()),times=nlevels(Dose)-1)
  names(FN_dose) <- levels(Dose)[-1]
  
  for(i in levels(Dose)[-1]){
    summaryDT[[i]] <- data.frame(summaryDose[[i]]['datatable'])
    fcHurdle[[i]] <- summaryDT[[i]] %>% 
      filter(datatable.contrast == paste0("Dose",i) & datatable.component == 'H') %>% 
      select(datatable.primerid, datatable.Pr..Chisq.)
    fcHurdle[[i]]$FDR <- p.adjust(fcHurdle[[i]]$datatable.Pr..Chisq., 'fdr')
  }
  
  mast.out <- do.call(cbind, lapply(fcHurdle, data.frame))
  mast.final <- mast.out[,grepl('FDR', colnames(mast.out))]
  rownames(mast.final) <- mast.out[, 1]
  mast.final$adjusted.p <- apply(mast.final, 1, function(x) min(x))
  DGE1[[parameter.updates$TestName[n]]][['MAST']] <- mast.final
  ###### END MAST ####
  
  pHH0[[parameter.updates$TestName[n]]] <- DGE1[[parameter.updates$TestName[n]]]$ppH0
  saveRDS(DGE1, file = 'DGE1.062221.RData')
  saveRDS(pHH0, file = 'ppH0.062221.RData')
  
  benchmark.list = list()
  for (t in names(DGE1[[parameter.updates$TestName[n]]])[-c(1)]){
    for (fc in c(0, 0.40)){
      for (pct in c(0, 0.05)){
        name <- paste0(t, '_', fc, '_', pct)
        benchmark <- benchmarkSim_batch(sim, DGE1[[parameter.updates$TestName[n]]][[t]], fc.threshold = fc, pct.expressed = pct)
        summary <- summarizeBenchmark(benchmark)
        summary$test = t
        summary$fc = fc
        summary$pct = pct
        benchmark.list[[name]] = summary
        saveRDS(benchmark.list, file = 'benchmark.list.061521.RData')
      }
    }
  }

  B.LIST[[parameter.updates$TestName[n]]] = do.call('rbind', benchmark.list)
  saveRDS(B.LIST, file = 'B.LIST.062221.RData')

  AUC1[[parameter.updates$TestName[n]]] = B.LIST[[parameter.updates$TestName[n]]] %>% filter(fc == 0 & pct == 0.05) %>% group_by(test) %>% summarise(auc = AUC(FPR, TPR))
  saveRDS(AUC1, file = 'AUC1.062221.RData')
  AUPR1[[parameter.updates$TestName[n]]] = B.LIST[[parameter.updates$TestName[n]]] %>% filter(fc == 0 & pct == 0.05) %>% group_by(test) %>% summarise(auc = AUC(precision, recall))
  saveRDS(AUPR1, file = 'AUPR1.062221.RData')
  
  AUC2[[parameter.updates$TestName[n]]] = B.LIST[[parameter.updates$TestName[n]]] %>% filter(fc == 0 & pct == 0) %>% group_by(test) %>% summarise(auc = AUC(FPR, TPR))
  saveRDS(AUC2, file = 'AUC2.062221.RData')
  AUPR2[[parameter.updates$TestName[n]]] = B.LIST[[parameter.updates$TestName[n]]] %>% filter(fc == 0 & pct == 0) %>% group_by(test) %>% summarise(auc = AUC(precision, recall))
  saveRDS(AUPR2, file = 'AUPR2.062221.RData')
}
```


```{r}
AUC1B <- AUC1
for (auc in names(AUC1)){
  AUC1B[[auc]] <- data.frame(AUC1B[[auc]])
  AUC1B[[auc]]$stat <- auc
  AUC1B[[auc]] <- cbind(
    AUC1B[[auc]],
    parameter.updates[which(parameter.updates$TestName == auc), ]
    )
}
AUC1B <- do.call('rbind', AUC1B)
ggplot(data = AUC1B, aes(x = test, y = auc)) +
  geom_violin() +
  geom_jitter(size = 2, aes(color = factor(FacLoc))) +
  theme_bw()

AUC1BRANK <- AUC1B %>% arrange(TestName, desc(auc)) %>% group_by(TestName) %>% mutate(rank = row_number())
ggplot(data = AUC1BRANK, aes(x = test, y = rank)) +
  geom_violin() +
  geom_jitter(size = 2) +
  labs(x = element_blank(), y = 'AUC Rank (1-7)', title = 'All Genes') +
  theme_bw()
```

```{r}
AUC2B <- AUC2
for (auc in names(AUC2)){
  AUC2B[[auc]] <- data.frame(AUC2B[[auc]])
  AUC2B[[auc]]$stat <- auc
  AUC2B[[auc]] <- cbind(
    AUC2B[[auc]],
    parameter.updates[which(parameter.updates$TestName == auc), ]
    )
}
AUC2B <- do.call('rbind', AUC2B)
ggplot(data = AUC2B, aes(x = test, y = auc)) +
  geom_violin() +
  geom_jitter(size = 2, aes(color = factor(TestName))) +
  theme_bw()

AUC2BRANK <- AUC2B %>% arrange(TestName, desc(auc)) %>% group_by(TestName) %>% mutate(rank = row_number())
ggplot(data = AUC2BRANK, aes(x = test, y = rank)) +
  geom_violin() +
  geom_jitter(size = 2) +
  labs(x = element_blank(), y = 'AUC Rank (1-7)', title = 'Percent expressed >= 5%') +
  theme_bw()
```

```{r}
AUPR1B <- AUPR1
for (auc in names(AUPR1)){
  AUPR1B[[auc]] <- data.frame(AUPR1B[[auc]])
  AUPR1B[[auc]]$stat <- auc
  AUPR1B[[auc]] <- cbind(
    AUPR1B[[auc]],
    parameter.updates[which(parameter.updates$TestName == auc), ]
    )
}
AUPR1B <- do.call('rbind', AUPR1B)
ggplot(data = AUPR1B, aes(x = test, y = auc)) +
  geom_violin() +
  geom_jitter(size = 2, aes(color = factor(FacLoc))) +
  theme_bw()

AUPR1BRANK <- AUPR1B %>% arrange(TestName, desc(auc)) %>% group_by(TestName) %>% mutate(rank = row_number())
ggplot(data = AUC2BRANK, aes(x = test, y = rank)) +
  geom_violin() +
  geom_jitter(size = 2) +
  labs(x = element_blank(), y = 'AUC Rank (1-7)', title = 'Percent expressed >= 5%') +
  theme_bw()
```

```{r}
AUPR2B <- AUPR2
for (auc in names(AUPR2)){
  AUPR2B[[auc]] <- data.frame(AUPR2B[[auc]])
  AUPR2B[[auc]]$stat <- auc
  AUPR2B[[auc]] <- cbind(
    AUPR2B[[auc]],
    parameter.updates[which(parameter.updates$TestName == auc), ]
    )
}
AUPR2B <- do.call('rbind', AUPR2B)
ggplot(data = AUPR2B, aes(x = test, y = auc)) +
  geom_violin() +
  geom_jitter(size = 2, aes(color = factor(TestName))) +
  theme_bw()

AUPR2BRANK <- AUPR2B %>% arrange(TestName, desc(auc)) %>% group_by(TestName) %>% mutate(rank = row_number())
ggplot(data = AUC2BRANK, aes(x = test, y = rank)) +
  geom_violin() +
  geom_jitter(size = 2) +
  labs(x = element_blank(), y = 'AUC Rank (1-7)', title = 'Percent expressed >= 5%') +
  theme_bw()
```


