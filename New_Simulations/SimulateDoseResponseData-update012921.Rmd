---
title: "R Notebook"
output: html_notebook
---

```{r}
library(matrixStats, quietly = TRUE)
library(ggplot2, quietly = TRUE)
library(cowplot, quietly = TRUE)
library(reshape2, quietly = TRUE)
library(dplyr, quietly = TRUE)
library(corrplot, quietly = TRUE)
memory.limit(size = 64000)
source('dose-responseModels.R')
source('simulateModels2.R')
```

##1. Real data was used to derive the following information for each gene:

__TO DO: INCORPORATE ORIGINAL CODE__

  * mean of non-zero normal distribution
  * standard deviation
  * percent zero
  * mean including zero's
  * variance
  
```{r fig.width = 12, fig.height = 3}
realData = readRDS('combined.RData')

norm_pz = ggplot(realData, aes (x = mean, y = percent.zero)) +
  geom_point(shape = 21, fill = 'lightblue', color = 'black', size = 1) + 
  ggtitle('Estimated mean (non-zero) ~ % zero') +
  facet_wrap(~dataset) +
  theme_classic()

mean_pz = ggplot(realData, aes (x = mean2, y = percent.zero)) +
  geom_point(shape = 21, fill = 'lightblue', color = 'black', size = 1) + 
  ggtitle('Calcuated mean (non-zero) ~ % zero') +
  facet_wrap(~dataset) +
  theme_classic()

mean_norm = ggplot(realData, aes (x = mean, y = mean2)) +
  geom_point(shape = 21, fill = 'lightblue', color = 'black', size = 1) + 
  ggtitle('Calcuated ~ estimated mean (non-zero)') +
  facet_wrap(~dataset) +
  theme_classic()

plot_grid(
norm_pz,
mean_pz,
mean_norm,
labels = 'AUTO',
label_size = 12,
ncol = 3
)
```
Estimated mean = mean for a normal distribution fit over the non-zero data
Calculated mean = mean of non-zero portion

## 2. Choose simulation parameters
```{r}
sim.doses = c(0, 0.01, 0.03, 0.1, 0.3, 1, 3, 10, 30) #Matches our study design
num.doses = length(sim.doses)
ncells = 500
min.mean = min(realData$mean); print(min.mean)
max.mean = max(realData$mean); print(max.mean)
s = 0 #Start ID for simulated data
```

## 3. Simulate the data
```{r fig.height= 8, echo = FALSE}
grViz("digraph flowchart {
      # node definitions with substituted label text
      node [fontname = Arial, shape = rectangle]        
      tab1 [label = '@@1']
      tab2 [label = '@@2']
      tab3 [label = '@@3']
      tab4 [label = '@@4']
      tab5 [label = '@@5']
      tab6 [label = '@@6']
      tab7 [label = '@@7']

      # edge definitions with the node IDs
      tab1 -> tab2 -> tab3 -> tab4 -> tab5 -> tab6 -> tab7;
      }

      [1]: 'Sample a random mean expression value from real data'
      [2]: 'Set as start value for dose 0 (i.e., control)'
      [3]: 'Use defined equation to calculate the mean other doses'
      [4]: 'Find nearest mean value in real data and get associated standard deviation and percent zeros'
      [5]: 'Sample values around the mean with associated standard deviation'
      [6]: 'Replace all values below 0 with 0'
      [7]: 'Fill with random zeros to achieve expected percent zero'
      ")
```


### Hill
  response = gamma + ( V * dose^n )/( k^n + dose^n )
```{r}
set.seed(1654)
hill.up = runSimulation(n = 150, start_id = s, class = 'Hill', realData = realData)
ggplot(data = reshape2::melt(hill.up$parameters), aes(x = value)) +
  facet_wrap(~variable, scales = 'free') +
  geom_density() +
  theme_bw()

hill.down = runSimulation(n = 150, start_id = hill.up$stop_id, class = 'Hill', realData = realData, downregulated = TRUE)
ggplot(data = reshape2::melt(hill.down$parameters), aes(x = value)) +
  facet_wrap(~variable, scales = 'free') +
  geom_density() +
  theme_bw()
```

### Exponential
  response = a * exp( sign * (b * dose)^1 )
```{r}
set.seed(2353)
exp.up = runSimulation(n = 150, start_id = hill.down$stop_id, class = 'Exp', realData = realData, downregulated = FALSE)
ggplot(data = reshape2::melt(exp.up$parameters), aes(x = value)) +
  facet_wrap(~variable, scales = 'free') +
  geom_density() +
  theme_bw()

exp.down = runSimulation(n = 150, start_id = exp.up$stop_id, class = 'Exp', realData = realData, downregulated = TRUE)
ggplot(data = reshape2::melt(exp.down$parameters), aes(x = value)) +
  facet_wrap(~variable, scales = 'free') +
  geom_density() +
  theme_bw()

```

### Exponential2
  response = a * exp( sign * (b * dose)^d )
```{r}
set.seed(8654)
exp2.up = runSimulation(n = 150, start_id = exp.down$stop_id, class = 'Exp', realData = realData, downregulated = FALSE, power = TRUE)
ggplot(data = reshape2::melt(exp2.up$parameters), aes(x = value)) +
  facet_wrap(~variable, scales = 'free') +
  geom_density() +
  theme_bw()

exp2.down = runSimulation(n = 150, start_id = exp2.up$stop_id, class = 'Exp', realData = realData, downregulated = TRUE, power = TRUE)
ggplot(data = reshape2::melt(exp2.down$parameters), aes(x = value)) +
  facet_wrap(~variable, scales = 'free') +
  geom_density() +
  theme_bw()
```

### Exponential3
  response = a * (c - (c - 1) * exp( -1 * (b * doses)^d ))
```{r}
set.seed(1532)
exp3.up = runSimulation(n = 150, start_id = exp2.down$stop_id, class = 'ExpB', realData = realData, downregulated = FALSE)
ggplot(data = reshape2::melt(exp3.up$parameters), aes(x = value)) +
  facet_wrap(~variable, scales = 'free') +
  geom_density() +
  theme_bw()

exp3.down = runSimulation(n = 150, start_id = exp3.up$stop_id, class = 'ExpB', realData = realData, downregulated = TRUE)
ggplot(data = reshape2::melt(exp3.down$parameters), aes(x = value)) +
  facet_wrap(~variable, scales = 'free') +
  geom_density() +
  theme_bw()
```


### Power
  response = gamma + beta * doses^delta
```{r}
set.seed(3322)
pow.up = runSimulation(n = 150, start_id = exp3.down$stop_id, class = 'Power', realData = realData, downregulated = FALSE, power = TRUE)
ggplot(data = reshape2::melt(pow.up$parameters), aes(x = value)) +
  facet_wrap(~variable, scales = 'free') +
  geom_density() +
  theme_bw()

pow.down = runSimulation(n = 150, start_id = pow.up$stop_id, class = 'Power', realData = realData, downregulated = TRUE, power = TRUE)
ggplot(data = reshape2::melt(pow.down$parameters), aes(x = value)) +
  facet_wrap(~variable, scales = 'free') +
  geom_density() +
  theme_bw()
```


### Linear
  response = gamma + beta * doses
```{r}
set.seed(2213)
lin.up = runSimulation(n = 150, start_id = pow.down$stop_id, class = 'Linear', realData = realData, downregulated = FALSE, power = TRUE)
ggplot(data = reshape2::melt(lin.up$parameters), aes(x = value)) +
  facet_wrap(~variable, scales = 'free') +
  geom_density() +
  theme_bw()

lin.down = runSimulation(n = 150, start_id = lin.up$stop_id, class = 'Linear', realData = realData, downregulated = TRUE, power = TRUE)
ggplot(data = reshape2::melt(lin.down$parameters), aes(x = value)) +
  facet_wrap(~variable, scales = 'free') +
  geom_density() +
  theme_bw()
```


```{r}
set.seed(8653)
unchanged = runSimulation(n = 500, start_id = lin.down$stop_id, class = 'Unchanged', realData = realData)
```


```{r}
simData = convert2snseq(realData,
                        rbind(
                          hill.up$data,
                          hill.down$data,
                          exp.up$data,
                          exp.down$data,
                          exp2.up$data,
                          exp2.down$data,
                          exp3.up$data,
                          exp3.down$data,
                          pow.up$data,
                          pow.down$data,
                          lin.up$data,
                          lin.down$data,
                          unchanged$data
                        ), 
                        ncells, sd.scale = 1, p.zero = 2)
```


# Sample expression plot for a gene fitting the hill model
```{r}
in.data = simData$out2 %>% filter(item == 24)
ggplot(data = in.data,  aes(factor(doses), value)) +
  geom_violin() + geom_jitter() +
  geom_point(data = hill.up$data %>% filter(item == 24), aes(x = factor(doses), y = resp), size = 3, color = 'red') +
  theme_bw()

hill.up$parameters[24]$k
```
# Sample expression plot for an unchanged gene
```{r}
in.data = simData$out2 %>% filter(item == 2108)
ggplot(data = in.data,  aes(factor(doses), value)) +
  geom_violin() + geom_jitter() +
  geom_point(data = unchanged$data %>% filter(item == 2108), aes(x = factor(doses), y = resp), size = 3, color = 'red') +
  theme_bw()

#hill.up$parameters[24]$k
```
#Preparing cell data for export
```{r}
tempData = simData$out2[order(simData$out2$doses),]
tempData$barcode = paste(tempData$variable, tempData$doses, sep = '_')
simCellMeta = unique(tempData[,c('barcode', 'doses')])
tempData = tempData[,c('item', 'barcode', 'value')]
tempData = dcast(tempData, item ~ barcode)
rownames(tempData) = paste('gene', tempData$item, sep = '')
tempData = tempData[,-1]
simDataFinal = tempData[,simCellMeta$barcode]
```

#Preparing gene metadata for export
```{r}
n = 150
simGeneMeta = data.frame(
  Gene = rownames(simDataFinal),
  Model = c(
    rep('hill', n*2),
    rep('exp', n*2),
    rep('exp2', n*2),
    rep('exp3', n*2),
    rep('power', n*2),
    rep('linear', n*2),
    rep('unchanged', 500)
  ),
  Direction = c(
    rep('Upregulated', n),
    rep('Downregulated', n),
    rep('Upregulated', n),
    rep('Downregulated', n),
    rep('Upregulated', n),
    rep('Downregulated', n),
    rep('Upregulated', n),
    rep('Downregulated', n),
    rep('Upregulated', n),
    rep('Downregulated', n),
    rep('Upregulated', n),
    rep('Downregulated', n),
    rep('NA', 500)
  )
)

GeneModelParams = list(
  hill.up = hill.up$parameters,
  hill.down = hill.down$parameters,
  exp.up = exp.up$parameters,
  exp.down = exp.down$parameters,
  exp2.up = exp2.up$parameters,
  exp2.down = exp2.down$parameters,
  exp3.up = exp3.up$parameters,
  exp3.down = exp3.down$parameters,
  pow.up = pow.up$parameters,
  pow.down = pow.down$parameters,
  lin.up = lin.up$parameters,
  lin.down = lin.down$parameters,
  unchanged = unchanged$parameters
)
```

```{r}
write.table(simDataFinal, file = 'simDataFinal.lognormcounts.txt', sep = '\t', quote = FALSE)
write.table(simCellMeta, file = 'simCellMeta.txt', sep = '\t', quote = FALSE)
write.table(simGeneMeta, file = 'simGeneMeta.txt', sep = '\t', quote = FALSE)
saveRDS(GeneModelParams, file = 'GeneModelParams.RData')
```



